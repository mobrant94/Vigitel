---
title: "Vigitel - Data analisys"
author: "Marcos Brum"
date: "`r Sys.Date()`"
output: 
  rmdformats::robobook:
    code_folding: hide
    number_sections: TRUE
---

# Vigitel
Access: https://svs.aids.gov.br/download/Vigitel/



```{r setup, echo=FALSE, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
options(scipen=999)
Sys.setlocale("LC_TIME", "Portuguese")
```

```{r packages, echo=FALSE, message=TRUE, warning=TRUE}

pacman::p_load(readxl,stringr,dplyr,ggplot2,geobr,sf, tableone)

```

```{r organization, echo=FALSE, message=FALSE, warning=FALSE, results="hide",include=FALSE}

# Lists all .xls files in the working directory
files <- list.files(pattern = "*.xls")

# Function to extract the year from the file name
extract_year <- function(file_name) {
  str_extract(file_name, "\\d{4}")
}

# Loop through each file and import them
for (file in files) {
  # Extract the year from the file name
  year <- extract_year(file)
  
  # Create the dataset name based on the year
  dataset_name <- paste0("df", substr(year, 3, 4))
  
  # Read the Excel file
  assign(dataset_name, read_excel(file))
}

# Checking the loaded datasets
ls(pattern = "df")


# Lists of datasets
data_frames <- list(df06 = df06, df07 = df07, df08 = df08, df09 = df09, df10 = df10, 
                    df11 = df11, df12 = df12, df13 = df13, df14 = df14, df15 = df15,
                    df16 = df16, df17 = df17, df18 = df18, df19 = df19, df20 = df20,
                    df21 = df21,df23 = df23)

# Adding the "ano_add" column to each data frame, if it exists
for (i in 6:23) {
  df_name <- paste0("df", sprintf("%02d", i))
  if (exists(df_name)) {
    data_frames[[df_name]] <- get(df_name) %>%
      mutate(ano_add = 2000 + i)
  }
}

# Function to rename variables
rename_vars <- function(df) {
  df <- df %>%
    rename(
      idade = q6,
      sexo = q7,
      estado_civil = civil,
      peso = q9,
      altura = q11,
      gravidez = q14,
      exercicio_fisico = q42,
      exercicio_semanal = q44,
      pressao_alta = q75,
      diabetes = q76,
      faixa_escolaridade = fesc,
      peso_imputado = q9_i,
      altura_imputada = q11_i
    )
  return(df)
}

rename_vars1 <- function(df) {
  df <- df %>%
    rename(
      idade = q6,
      sexo = q7,
      estado_civil = civil,
      peso = q9,
      altura = q11,
      gravidez = q14,
      exercicio_fisico = q42,
      exercicio_semanal = q44,
      pressao_alta = q75,
      faixa_escolaridade = fesc,
      peso_imputado = q9_i,
      altura_imputada = q11_i
    )
  return(df)
}



# Applying the function to relevant datasets (df06 to df23, excluding df22)
df06 <- rename_vars(df06)
df07 <- rename_vars(df07)
df08 <- rename_vars(df08)
df09 <- rename_vars(df09)
df10 <- rename_vars(df10)
df11 <- rename_vars(df11)
df12 <- rename_vars(df12)
df13 <- rename_vars(df13)
df14 <- rename_vars1(df14)
df15 <- rename_vars(df15)
df16 <- rename_vars(df16)
df17 <- rename_vars(df17)
df18 <- rename_vars(df18)
df19 <- rename_vars(df19)
df20 <- rename_vars(df20)
df21 <- rename_vars(df21)
df23 <- rename_vars(df23)


# Create a list of all datasets except df22
dataset_names <- c(paste0("df", sprintf("%02d", 6:21)), "df23")

# Function to select variables and add the year
select_and_add_year <- function(data, year) {
  data %>%
    select(idade, cidade, sexo, estado_civil, peso, altura, gravidez, exercicio_fisico, fumante, exercicio_semanal) %>%
    mutate(ano_add = year)
}

# Apply the function to all datasets
datasets <- lapply(seq_along(dataset_names), function(i) {
  dataset_name <- dataset_names[i]
  year <- 2000 + i + 5  # Calculando o ano correspondente (por exemplo, df06 é 2006)
  if (exists(dataset_name)) {
    dataset <- get(dataset_name)
    select_and_add_year(dataset, year)
  }
})

# Remove any null elements (if any dataset doesn't exist)
datasets <- Filter(Negate(is.null), datasets)

# Combine all datasets into one
combined_dataset <- bind_rows(datasets)

# Calculate BMI and categorize obesity
combined_dataset <- combined_dataset %>%
  mutate(imc = ifelse(peso != 888 & altura != 888, 
                      peso / ((altura / 100) * (altura / 100)), 
                      NA))

#Remove NA's and non-real values
combined_dataset = combined_dataset %>% filter(!(altura==888))
combined_dataset = combined_dataset %>% filter(!(peso==888))
combined_dataset = combined_dataset %>% filter(!(peso==777))
combined_dataset = combined_dataset %>% filter(!(peso==777))
combined_dataset = combined_dataset %>% filter(!(peso>250))

combined_dataset <- combined_dataset %>%
  mutate(
    obesidade = ifelse(imc > 29.9, "Yes", "No"),
    obesidade_morbid = ifelse(imc > 40, "Yes", "No")
  )

combined_dataset <- combined_dataset %>%
  mutate(
    idade_categoria = case_when(
      idade >= 18 & idade <= 30 ~ "18-30",
      idade >= 31 & idade <= 49 ~ "31-49",
      idade >= 50 & idade <= 59 ~ "50-59",
      idade >= 60 & idade <= 69 ~ "60-69",
      idade >= 70 ~ "70+"
    ))


# Create a vector mapping city codes to names
city_codes <- c("1" = "Aracaju",
                "2" = "Belem",
                "3" = "Belo Horizonte",
                "4" = "Boa Vista",
                "5" = "Campo Grande",
                "6" = "Cuiaba",
                "7" = "Curitiba",
                "8" = "Florianópolis",
                "9" = "Fortaleza",
                "10" = "Goiânia",
                "11" = "João Pessoa",
                "12" = "Macapá",
                "13" = "Maceio",
                "14" = "Manaus",
                "15" = "Natal",
                "16" = "Palmas",
                "17" = "Porto alegre",
                "18" = "Porto velho",
                "19" = "Recife",
                "20" = "Rio Branco",
                "21" = "Rio de Janeiro",
                "22" = "Salvador",
                "23" = "São Luís",
                "24" = "São Paulo",
                "25" = "Teresina",
                "26" = "Vitória",
                "27" = "Distrito federal")
# Recode the city variable in your dataset
combined_dataset <- combined_dataset %>%
  mutate(cidade = recode(as.character(cidade), !!!city_codes))

```

```{r ggplot2, echo=FALSE, message=FALSE, echo=FALSE, comment=FALSE, include=FALSE}

# Create a dataframe to store counts
list2env(data_frames, envir = .GlobalEnv)

contagens <- data.frame(ano = integer(), n = integer())

# Count observations in each data frame
for (i in 6:23) {
  df_name <- paste0("df", sprintf("%02d", i))
  if (exists(df_name)) {
    df <- get(df_name)
    ano <- 2000 + i
    n <- nrow(df)
    contagens <- rbind(contagens, data.frame(ano = ano, n = n))
  }
}
```

## Introduction

Vigitel shows some variation in respondents over time, and I conducted data exploration to identify trends.
Please feel free to suggest any data that could be observed.

### Fig 1. Count of respondents
```{r ggplot, echo=FALSE, message=FALSE, echo=FALSE}
# Create a bar plot
ggplot(contagens, aes(x = factor(ano), y = n)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  ylim(0, 55000) +
  labs(title = "", x = "Period", y = "Count of respondents") +
  theme_minimal() +
  geom_text(aes(label = n), vjust = -0.5)


```

### Table 1. Responses by city.

We observed a reduction in responses between 2020-2021.

```{r table, echo=FALSE}
# Create the table of total respondents by city and year
tabela_resposta <- combined_dataset %>%
  group_by(cidade) %>%
  summarise(total_respondents = n())

DT::datatable(tabela_resposta, rownames = FALSE,
              colnames = c("City", "Respondents"))

```
### Table 2. Responses by age category.

Most responses are concentrated between ages 31-49.
```{r table2, echo=FALSE}
tabela_resposta_idade <- combined_dataset %>%
  group_by(idade_categoria) %>%
  summarise(total_respondentes = n())

DT::datatable(tabela_resposta_idade, rownames = FALSE,
              colnames = c("Age range", "Respondents"))


```


### Fig 2. Proportion of obesity by year

It seems there is an increasing trend in obesity over time in Brazil (BMI > 29.9).
```{r ggplot21, echo=FALSE, fig.width=10, fig.height=6}
#################Obesity#################################


obesidade_por_ano <- table(combined_dataset$obesidade, combined_dataset$ano_add)

# Calculate obesity proportions by year
proporcao_obesidade_por_ano <- prop.table(obesidade_por_ano, margin = 2)

# Convert the proportions table into a data frame
proporcao_obesidade_df <- as.data.frame(proporcao_obesidade_por_ano)
colnames(proporcao_obesidade_df) <- c("obesity", "year", "proportion")

# Create the plot
ggplot(proporcao_obesidade_df, aes(fill = obesity, y = proportion * 100, x = year)) + 
  geom_bar(position = "stack", stat = "identity") +
  labs(fill = "Obesity", x = "Period", y = "Proportion (%)") +
  geom_text(aes(label = sprintf("%.1f%%", proportion * 100)), 
            position = position_stack(vjust = 0.5), 
            size = 3, 
            color = "black") +
  theme_minimal()




```

### Fig 3. Proportion of extreme obesity by year.

I could not identify significant changes in extreme obesity (BMI > 40).
```{r ggplotextra, echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=7}
# Calculate proportions of morbid obesity by year
proporcao_obesidade_morbid <- combined_dataset %>%
  group_by(ano_add, obesidade_morbid) %>%
  summarise(count = n()) %>%
  group_by(ano_add) %>%
  mutate(proporcao = count / sum(count))

# Create the bar plot
ggplot(proporcao_obesidade_morbid, aes(x = factor(ano_add), y = proporcao*100, fill = obesidade_morbid)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "",
       x = "Year",
       y = "Proportion",
       fill = "Extreme Obesity") +
  scale_fill_manual(values = c("Yes" = "skyblue", "No" = "orange")) +  # Set colors for "Yes" and "No"
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



### Fig 4. Proportion of smokers by year
Here I present the description of some data related to smoking. We observed a slight reduction in the proportion of smokers over time.

```{r ggplot3, echo=FALSE, fig.width=10, fig.height=6}

###############Smoking##########################
# Recode the smoking variable in your dataset
combined_dataset <- combined_dataset %>%
  mutate(fumante = recode(as.character(fumante), "1" = "Yes", "0" = "No"))

# Calculate smoking proportions by year
fumante_por_ano <- table(combined_dataset$fumante, combined_dataset$ano_add)
proporcao_fumante_por_ano <- prop.table(fumante_por_ano, margin = 2)

# Convert the proportions table into a data frame
proporcao_fumante_df <- as.data.frame(proporcao_fumante_por_ano)
colnames(proporcao_fumante_df) <- c("smoking", "year", "proportion")

# Criar o gráfico com rótulos nas barras
ggplot(proporcao_fumante_df, aes(fill = smoking, y = proportion*100, x = year)) + 
  geom_bar(position = "stack", stat = "identity") +
  geom_text(aes(label = paste0(round(proportion * 100, 1), "%")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +
  labs(fill = "Smoking", x = "Period", y = "Proportion") +
  theme_minimal()

```

### Fig 5. Proportion of smokers by city

Observing the proportion of smokers by city, we highlight high proportions in Porto Alegre (Rio Grande do Sul), São Paulo (São Paulo), and Curitiba (Parana).

```{r ggplot4, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
# Filter only observations with complete smoking and city data
dados_fumante_cidade <- combined_dataset %>%
  filter(!is.na(fumante) & !is.na(cidade))

# Calculate smoking proportions (Yes or No) by city
proporcao_fumante_cidade <- dados_fumante_cidade %>%
  group_by(cidade, fumante) %>%
  summarise(count = n()) %>%
  group_by(cidade) %>%
  mutate(proporcao = count / sum(count))

# Create the bar plot
ggplot(proporcao_fumante_cidade, aes(x = cidade, y = proporcao * 100, fill = fumante)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = paste0(round(proporcao * 100, 1), "%")),
            position = position_stack(vjust = 0.5), size = 3, color = "black") +
  labs(title = "",
       x = "City",
       y = "Proportion - %",
       fill = "Smoker") +
  scale_fill_manual(values = c("Yes" = "skyblue", "No" = "orange")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 101)



```

### Fig 6. Proportion of Smokers by Age Category

When observing the proportion of smokers by age group, the highest proportion is found among those aged 50-59. In our work on COPD mortality (under construction), the highest prevalence age group is >60 years.

```{r ggplot5, echo=FALSE}

############Smoking per age#########

# Filter only observations with complete data for smoking and age category
dados_fumante_idade <- combined_dataset %>%
  filter(!is.na(fumante) & !is.na(idade_categoria))

# Calculate proportions of smokers by age category
proporcao_fumante_idade <- dados_fumante_idade %>%
  group_by(idade_categoria, fumante) %>%
  summarise(count = n()) %>%
  group_by(idade_categoria) %>%
  mutate(proporcao = count / sum(count))

# Create the bar plot
ggplot(proporcao_fumante_idade, aes(x = idade_categoria, y = proporcao, fill = fumante)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = scales::percent(proporcao)), 
            position = position_stack(vjust = 0.5), 
            color = "black", size = 3) +  # Add labels with percentage format
  labs(title = "",
       x = "Age Category",
       y = "Proportion",
       fill = "Smoker") +
  scale_fill_manual(values = c("Yes" = "skyblue", "No" = "orange")) +  # Set colors for "Yes" and "No"
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### Fig 7. Proportion of Smokers by Age Category and City

The last figure refers to an exploration of the proportion of smokers by age group and capital city.

```{r ggplot6, echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=7}
# Calculate smoking proportions by age category and city.
proporcao_fumante_idade_cidade <- combined_dataset %>%
  group_by(cidade, idade_categoria) %>%
  summarise(proporcao = mean(fumante == "Yes"))

# To order the age categories according to the desired sequence:
proporcao_fumante_idade_cidade$idade_categoria <- factor(proporcao_fumante_idade_cidade$idade_categoria,
                                                         levels = c("18-30", "31-49", "50-59", "60-69", "70+"))

ggplot(proporcao_fumante_idade_cidade, aes(x = idade_categoria, y = proporcao*100)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ cidade, scales = "free") +
  labs(title = "",
       x = "Age Category",
       y = "Proportion - %",
       fill = "Smoker") +
  scale_fill_manual(values = c("Yes" = "skyblue", "No" = "orange")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 8, face = "bold")) +
  ylim(0, 30)

```
Code: 